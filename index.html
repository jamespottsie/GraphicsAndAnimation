<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>My first three.js app</title>
    <style>
        body {
            margin: 0;
        }
        
        canvas {
            display: block;
        }
    </style>
</head>

<body onload="init()">
    <script src="node_modules/three/build/three.min.js"></script>
    <script src="node_modules/three/examples/js/loaders/GLTFLoader.js"></script>
    <script>
        "use strict";

        var canvas, renderer, scene, camera; // Standard three.js requirements.
        var bird;
        var frameNumber;

        var flap = false;
        var turnAmount = 0.0;

        //#region WORLD SETUP
        function createWorld() {
            scene = new THREE.Scene();

            // ------------------- Camera etc ----------------------

            camera = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 1, 6);
            camera.rotation.x = -0.1;


            const textureLoader = new THREE.TextureLoader();
            const texture = textureLoader.load(
                'Assets/mars.png',
                () => {
                    const rt = new THREE.WebGLCubeRenderTarget(texture.image.height);
                    rt.fromEquirectangularTexture(renderer, texture);
                    scene.background = rt;
                });


            var light;
            light = new THREE.DirectionalLight();
            light.position.set(0, 0, 1);
            camera.add(light);
            scene.add(camera);

            //------------------- Visible objects ----------------------

            var loader = new THREE.GLTFLoader();

            loader.load('/Assets/bird.gltf', function(gltf) {
                bird = gltf.scene;
                scene.add(gltf.scene);
                bird.rotation.y = 3.14;
            });

        }
        //#endregion


        //UPDATE
        function updateForFrame() {
            if (flap)
                flapBird(0.35);
            else
                flapBird(-0.02);
            birdTurn(turnAmount);
        }

        function doFrame() {
            frameNumber++;
            if (bird != null)
                updateForFrame();
            renderer.render(scene, camera);
            requestAnimationFrame(doFrame);
        }

        //#region PC CONTROLS
        window.addEventListener('keydown', function(e) {
            if (e.keyCode === null)
                return;
            switch (e.keyCode) {
                case 32:
                    flap = true;
                    break;
                case 65:
                    turnAmount = -1.0;
                    break;
                case 68:
                    turnAmount = 1.0;
                    break;
            }
            e.preventDefault();
        });
        window.addEventListener('keyup', function(e) {
            if (e.keyCode === null)
                return;
            switch (e.keyCode) {
                case 32:
                    flap = false;
                    break;
                case 65:
                    if (turnAmount === -1.0)
                        turnAmount = 0;
                    break;
                case 68:
                    if (turnAmount === 1.0)
                        turnAmount = 0;
                    break;
            }
            e.preventDefault();
        });
        //#endregion

        //#region BIRD CONTROLS
        var ySpeed = 0;

        function flapBird(flapSpeed) {
            if (flapSpeed < 0) {
                if (ySpeed > -0.45)
                    ySpeed += flapSpeed;
            } else {
                ySpeed = flapSpeed;
            }
            bird.position.y += 0.04 * ySpeed;
        }

        var xSpeed = 0.0;
        var zRot = 0.0;

        function birdTurn(turnSpeed) {
            xSpeed = lerp(xSpeed, 0.015 * turnSpeed, 0.02);
            zRot = lerp(zRot, 0.012 * turnSpeed, 0.025)
                //xSpeed = clamp(xSpeed, -0.01, 0.01);
            bird.position.x += xSpeed;
            bird.rotation.z = zRot * 85;
        }

        function clamp(v, min, max) {
            return Math.min(Math.max(v, min), max);
        }

        function lerp(a, b, n) {
            return (1 - n) * a + n * b;
        }
        //#endregion

        //#region INITIALIZATION
        function init() {
            try {
                renderer = new THREE.WebGLRenderer({
                    antialias: true,
                    alpha: false
                });

                renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(renderer.domElement);
            } catch (e) {
                document.body.innerHTML = "<b>Sorry, an error occurred:<br>" +
                    e + "</b>";
                return;
            }
            createWorld();
            doFrame();
        }

        //#endregion
    </script>

    <noscript>
    <p style="color: #AA0000; font-weight: bold">Sorry, but this page requires JavaScript!</p>
  </noscript>
</body>

</html>